<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Campaign Analyzer - Poste Italiane</title>
    <link rel="icon" type="image/png" href="camp.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #333;
            line-height: 1.6;
        }

        /* Header Section */
        header {
            background: linear-gradient(135deg, #FFD800 0%, #ffed4a 100%);
            padding: 30px 20px;
            box-shadow: 0 4px 20px rgba(255, 216, 0, 0.3);
        }

        header h1 {
            margin: 0;
            color: #0033A0;
            font-size: 2.2em;
            font-weight: 600;
            text-align: center;
        }

        .header-subtitle {
            text-align: center;
            color: #0033A0;
            font-size: 1.1em;
            margin-top: 10px;
            opacity: 0.8;
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }

        /* Section Styling */
        .section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
            border-left: 4px solid #FFD800;
        }

        .section-title {
            color: #0033A0;
            font-size: 1.5em;
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* File Upload Styling */
        .upload-section {
            border: 2px dashed #0033A0;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .upload-section:hover {
            border-color: #FFD800;
            background: #fffef8;
        }

        .upload-section.dragover {
            border-color: #FFD800;
            background: #fffbcd;
            transform: scale(1.02);
        }

        input[type="file"] {
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid #ccc;
            border-radius: 8px;
            font-family: inherit;
            font-size: 1em;
            width: 100%;
            max-width: 400px;
        }

        input[type="file"]:focus {
            border-color: #0033A0;
            outline: none;
        }

        /* Button Styling */
        button {
            background: linear-gradient(135deg, #0033A0 0%, #0056b3 100%);
            color: #fff;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            margin-right: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            min-width: 150px;
            justify-content: center;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 51, 160, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button.loading {
            background: #e0e0e0;
            color: #666;
            cursor: not-allowed;
        }

        button.success {
            background: linear-gradient(135deg, #28a745 0%, #34ce57 100%);
            color: white;
        }

        .secondary-btn {
            background: linear-gradient(135deg, #FFD800 0%, #ffed4a 100%);
            color: #0033A0;
        }

        .secondary-btn:hover {
            box-shadow: 0 4px 15px rgba(255, 216, 0, 0.4);
        }

        /* Report Section */
        #report {
            white-space: pre-wrap;
            border: 1px solid #e0e6ed;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            background: #f8f9ff;
            font-size: 1em;
            line-height: 1.6;
        }

        #report strong {
            color: #0033A0;
            font-weight: 600;
        }

        #report a {
            color: #0033A0;
            text-decoration: underline;
        }

        #report a:hover {
            color: #FFD800;
        }

        #report em {
            font-style: italic;
            color: #666;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .metric-card {
            background: linear-gradient(135deg, #0033A0 0%, #0056b3 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 51, 160, 0.2);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Charts Section */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .chart-wrapper {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
            border-left: 4px solid #FFD800;
        }

        .chart-title {
            font-size: 1.2rem;
            color: #0033A0;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .chart {
            width: 100%;
            height: 400px;
        }

        .export-section {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            padding-top: 20px;
            border-top: 1px solid #e0e6ed;
            margin-top: 20px;
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #666;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            header h1 {
                font-size: 1.8em;
            }
            
            .section {
                padding: 20px;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            button {
                width: 100%;
                margin-right: 0;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <header>
        <h1>
            <svg width="40" height="40" viewBox="0 0 24 24" fill="#0033A0" style="vertical-align: middle; margin-right: 10px;">
                <path d="M7,2V8H2V2H7M9,2V8H16V2H9M18,2V8H22V2H18M7,10V16H2V10H7M9,10V16H16V10H9M18,10V16H22V10H18M7,18V22H2V18H7M9,18V22H16V18H9M18,18V22H22V18H18Z"/>
            </svg>
            Social Campaign Analyzer
        </h1>
        <p class="header-subtitle">Strumento di analisi campagne social - Poste Italiane</p>
    </header>

    <div class="container">
        <!-- Upload Section -->
        <div class="section">
            <h2 class="section-title">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="#0033A0">
                    <path d="M10,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V8C22,6.89 21.1,6 20,6H12L10,4Z"/>
                </svg>
                Carica il file Excel
            </h2>
            <div class="upload-section" id="uploadArea">
                <div style="font-size: 3rem; margin-bottom: 15px; color: #0033A0;">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="#0033A0">
                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M12,12L8,16H10.5V19H13.5V16H16L12,12Z"/>
                    </svg>
                </div>
                <p><strong>Trascina qui il file Excel</strong></p>
                <p>oppure clicca per selezionare (.xlsx)</p>
                <input type="file" id="file-input" accept=".xlsx" />
            </div>
            
            <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                <button id="copy-btn" class="secondary-btn">
                    <span>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="#0033A0">
                            <path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/>
                        </svg>
                    </span>
                    <span>Copia Testo</span>
                </button>
                <button id="download-btn">
                    <span>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                            <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20M10,10H11V13H10V10M13,10H14V13H13V10M9,9.5V13.5L12,16.5L15,13.5V9.5L12,12.5L9,9.5Z"/>
                        </svg>
                    </span>
                    <span>Scarica Word</span>
                </button>
                <button id="download-html-btn" class="secondary-btn">
                    <span>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="#0033A0">
                            <path d="M12,17.56L16.07,16.43L16.62,10.33H9.38L9.2,8.3H16.8L17,6.31H7L7.56,12.32H14.45L14.22,14.9L12,15.5L9.78,14.9L9.64,13.24H7.64L7.93,16.43L12,17.56M4.07,3H19.93L18.5,19.2L12,21L5.5,19.2L4.07,3Z"/>
                        </svg>
                    </span>
                    <span>Scarica HTML</span>
                </button>
            </div>
        </div>

        <!-- Report Section -->
        <div class="section">
            <h2 class="section-title">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="#0033A0">
                    <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M12,12L8,16H10.5V19H13.5V16H16L12,12Z"/>
                </svg>
                Report Testuale
            </h2>
            <div id="report">Il report verrà generato qui...</div>
        </div>

        <!-- Analytics Section -->
        <div id="analyticsSection" class="hidden">
            <div class="section">
                <h2 class="section-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="#0033A0">
                        <path d="M22,21H2V3H4V19H6V10H10V19H12V6H16V19H18V14H22V21Z"/>
                    </svg>
                    Metriche Generali
                </h2>
                <div class="metrics-grid" id="metricsGrid"></div>
                <div class="export-section">
                    <button class="secondary-btn" id="exportMetricsBtn">
                        <span>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="#0033A0">
                                <path d="M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z"/>
                            </svg>
                        </span>
                        <span>Esporta Metriche SVG</span>
                    </button>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="#0033A0">
                        <path d="M7,2V13H10V22L17,10H13L17,2H7Z"/>
                    </svg>
                    Grafici di Analisi
                </h2>
                <div class="charts-container" id="chartsContainer"></div>
                <div class="export-section">
                    <button class="secondary-btn" id="exportAllBtn">
                        <span>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="#0033A0">
                                <path d="M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z"/>
                            </svg>
                        </span>
                        <span>Esporta Tutti i Grafici SVG</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let latestHtml = "";
        let campaignData = null;
        let campaignLabel = "";

        // Social media logos SVG - all in Poste blue color
        const socialLogos = {
            facebook: `<svg width="20" height="20" viewBox="0 0 24 24" fill="#0033A0"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>`,
            instagram: `<svg width="20" height="20" viewBox="0 0 24 24" fill="#0033A0"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zM5.838 12a6.162 6.162 0 1112.324 0 6.162 6.162 0 01-12.324 0zM12 16a4 4 0 110-8 4 4 0 010 8zm4.965-10.405a1.44 1.44 0 112.881.001 1.44 1.44 0 01-2.881-.001z"/></svg>`,
            x: `<svg width="20" height="20" viewBox="0 0 24 24" fill="#0033A0"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>`,
            twitter: `<svg width="20" height="20" viewBox="0 0 24 24" fill="#0033A0"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>`,
            linkedin: `<svg width="20" height="20" viewBox="0 0 24 24" fill="#0033A0"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>`,
            youtube: `<svg width="20" height="20" viewBox="0 0 24 24" fill="#0033A0"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>`,
            sconosciuto: `<svg width="20" height="20" viewBox="0 0 24 24" fill="#0033A0"><circle cx="12" cy="12" r="10" stroke="#0033A0" stroke-width="2" fill="none"/><text x="12" y="16" text-anchor="middle" font-size="14" fill="#0033A0">?</text></svg>`
        };

        // Funzioni helper (dalla versione originale)
        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
        }

        function formatNumber(value) {
            if (isNaN(value)) return "0";
            if (value < 1000) return value.toString();
            if (value < 1000000) {
                let result = (value / 1000).toFixed(2);
                return result.replace(".", ",").replace(/,00$/, "") + "K";
            }
            let result = (value / 1000000).toFixed(2);
            return result.replace(".", ",").replace(/,00$/, "") + "M";
        }

        function formatNumberForCharts(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1).replace(".", ",") + 'M';
            }
            if (num >= 1000) {
                return (num / 1000).toFixed(1).replace(".", ",") + 'K';
            }
            return num.toString();
        }

        function cleanLabel(label) {
            const tags = ["#PES", "#TER", "#ISR", "#FIL", "#EB", "#NED", "#CET", "#DEI", "#ST", "#RIC"];
            tags.forEach(tag => {
                label = label.replace(tag, "");
            });
            return label.replace(/;/g, "").trim();
        }

        function generateList(title, obj) {
            const entries = Object.entries(obj)
                .filter(([_, v]) => v > 0)
                .sort((a, b) => b[1] - a[1])
                .map(([k, v]) => `${capitalize(k)}: ${formatNumber(v)}`)
                .join("<br>");
            return `<p><strong>${title}:</strong><br>${entries}</p><br>`;
        }

        function generateLinkSection(linksByPlatform, missingCount) {
            let html = "<br><strong>Link ai post:</strong><br>";
            Object.entries(linksByPlatform).forEach(([platform, links]) => {
                html += `<br><strong>${platform}</strong><br>`;
                links.forEach(link => {
                    html += `<a href="${link}" target="_blank">${link}</a><br>`;
                });
            });
            if (missingCount > 0) {
                html += `<br><em>N.B. L'elenco dei link non contiene le ${missingCount} Instagram stories.</em>`;
            }
            return html;
        }

        // Upload handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('file-input');

        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('drop', handleDrop);
        uploadArea.addEventListener('dragleave', handleDragLeave);

        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].name.endsWith('.xlsx')) {
                processExcelFile(files[0]);
            }
        }

        function processExcelFile(file) {
            const reader = new FileReader();
            reader.onload = function(evt) {
                const data = evt.target.result;
                const workbook = XLSX.read(data, {type: 'binary'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(sheet, {defval: ""});
                generateHtmlReport(jsonData);
                generateCharts(jsonData);
            };
            reader.readAsBinaryString(file);
        }

        function generateHtmlReport(data) {
            const postsByPlatform = {}, viewsByPlatform = {}, interactionsByPlatform = {},
                  reactionsByPlatform = {}, clicksByPlatform = {},
                  linksByPlatform = {};
            let totalViews = 0, totalInteractions = 0, totalReactions = 0, totalClicks = 0;
            let missingInstagramStories = 0;

            data.forEach(row => {
                let platform = row["Platform"]?.toString().trim().toLowerCase() || "Sconosciuto";
                if (platform === "twitter") platform = "X";
                const capitalizedPlatform = platform.charAt(0).toUpperCase() + platform.slice(1);

                postsByPlatform[platform] = (postsByPlatform[platform] || 0) + 1;
                const views = parseFloat(row["Total impressions"]) || parseFloat(row["Video view count"]) || 0;
                const interactions = parseFloat(row["Total interactions"]) || parseFloat(row["Taps forward"]) || 0;
                const reactions = parseFloat(row["Total reactions"]) || 0;
                const clicks = parseFloat(row["Post clicks"]) || 0;
                const link = row["View on platform"]?.toString().trim();

                viewsByPlatform[platform] = (viewsByPlatform[platform] || 0) + views;
                interactionsByPlatform[platform] = (interactionsByPlatform[platform] || 0) + interactions;
                reactionsByPlatform[platform] = (reactionsByPlatform[platform] || 0) + reactions;
                clicksByPlatform[platform] = (clicksByPlatform[platform] || 0) + clicks;

                if (link) {
                    if (!linksByPlatform[capitalizedPlatform]) linksByPlatform[capitalizedPlatform] = [];
                    linksByPlatform[capitalizedPlatform].push(link);
                } else if (capitalizedPlatform === "Instagram") {
                    missingInstagramStories++;
                }

                totalViews += views;
                totalInteractions += interactions;
                totalReactions += reactions;
                totalClicks += clicks;
            });

            const totalPosts = data.length;
            const label = cleanLabel(data.find(row => row["Labels"])?.["Labels"] || "");
            campaignLabel = label; // Store for later use

            const html =
                `Risultati della campagna social dedicata all'argomento "${label}"<br>` +
                `<strong>Complessivamente sono stati pubblicati ${totalPosts} post</strong>, ` +
                `che hanno ottenuto <strong>${formatNumber(totalViews)}</strong> visualizzazioni ` +
                `e <strong>${formatNumber(totalInteractions)}</strong> interazioni.<br>` +
                `Nello specifico i dati sono così ripartiti tra i diversi canali:<br><br>` +
                generateList("Numero post", postsByPlatform) +
                generateList("Visualizzazioni", viewsByPlatform) +
                generateList("Interazioni", interactionsByPlatform) +
                generateList("Like e reazioni", reactionsByPlatform) +
                generateList("Click", clicksByPlatform) +
                generateLinkSection(linksByPlatform, missingInstagramStories);

            latestHtml = html;
            document.getElementById("report").innerHTML = html;

            // Store data for charts
            campaignData = {
                totalPosts,
                totalViews,
                totalInteractions,
                totalReactions,
                totalClicks,
                platforms: {}
            };

            Object.keys(postsByPlatform).forEach(platform => {
                campaignData.platforms[platform] = {
                    posts: postsByPlatform[platform] || 0,
                    views: viewsByPlatform[platform] || 0,
                    interactions: interactionsByPlatform[platform] || 0,
                    reactions: reactionsByPlatform[platform] || 0,
                    clicks: clicksByPlatform[platform] || 0
                };
            });
        }

        function generateCharts(data) {
            if (!campaignData) return;

            generateMetrics();
            generateChartsVisual();
            document.getElementById('analyticsSection').classList.remove('hidden');
        }

        function generateMetrics() {
            const metricsGrid = document.getElementById('metricsGrid');
            const metrics = [
                { label: 'Post Totali', value: campaignData.totalPosts },
                { label: 'Visualizzazioni', value: formatNumberForCharts(campaignData.totalViews) },
                { label: 'Interazioni', value: formatNumberForCharts(campaignData.totalInteractions) },
                { label: 'Like e Reazioni', value: formatNumberForCharts(campaignData.totalReactions) }
            ];

            const metricsHtml = metrics.map(metric => `
                <div class="metric-card">
                    <div class="metric-value">${metric.value}</div>
                    <div class="metric-label">${metric.label}</div>
                </div>
            `).join('');
            
            metricsGrid.innerHTML = metricsHtml;
            
            // Create SVG version of metrics for export
            createMetricsSVG(metrics);
        }

        function createMetricsSVG(metrics) {
            const svgWidth = 800;
            const svgHeight = 250; // Ridotto da 320
            const cardWidth = 180;
            const cardHeight = 120;
            const spacing = 20;
            const startX = (svgWidth - (metrics.length * cardWidth + (metrics.length - 1) * spacing)) / 2;
            const startY = 45; // Ridotto da 60
            
            let svg = `<svg width="${svgWidth}" height="${svgHeight}" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="metricsGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#0033A0;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#0056b3;stop-opacity:1" />
                    </linearGradient>
                </defs>`;
                
            // Title
            svg += `<text x="${startX}" y="25" text-anchor="start" 
                    font-family="'Avenir Next LT Pro', Arial, sans-serif" font-size="20" 
                    fill="#0033A0" font-weight="400">Metriche Generali</text>`;
            
            metrics.forEach((metric, index) => {
                const x = startX + index * (cardWidth + spacing);
                const y = startY;
                
                // Card background
                svg += `<rect x="${x}" y="${y}" width="${cardWidth}" height="${cardHeight}" 
                        fill="url(#metricsGradient)" rx="12" ry="12"/>`;
                
                // Value text
                svg += `<text x="${x + cardWidth/2}" y="${y + 50}" text-anchor="middle" 
                        font-family="'Avenir Next LT Pro', Arial, sans-serif" font-size="32" 
                        fill="white" font-weight="bold">${metric.value}</text>`;
                
                // Label text
                svg += `<text x="${x + cardWidth/2}" y="${y + 80}" text-anchor="middle" 
                        font-family="'Avenir Next LT Pro', Arial, sans-serif" font-size="14" 
                        fill="white" opacity="0.9">${metric.label}</text>`;
            });
            
            svg += '</svg>';
            window.metricsSVG = svg;
        }

        function generateChartsVisual() {
            const container = document.getElementById('chartsContainer');
            container.innerHTML = '';

            // Posts by platform chart (NEW - added as first chart)
            const postsData = Object.entries(campaignData.platforms)
                .map(([name, data]) => ({ name: capitalize(name), value: data.posts }))
                .sort((a, b) => b.value - a.value);
            const postsChart = createBarChart('Post Pubblicati', postsData, true);

            // Views by platform chart (sorted)
            const viewsData = Object.entries(campaignData.platforms)
                .map(([name, data]) => ({ name: capitalize(name), value: data.views }))
                .sort((a, b) => b.value - a.value);
            const viewsChart = createBarChart('Visualizzazioni', viewsData);

            // Interactions by platform chart (sorted)
            const interactionsData = Object.entries(campaignData.platforms)
                .map(([name, data]) => ({ name: capitalize(name), value: data.interactions }))
                .sort((a, b) => b.value - a.value);
            const interactionsChart = createBarChart('Interazioni', interactionsData);

            // Like e reazioni chart (sorted)
            const reactionsData = Object.entries(campaignData.platforms)
                .map(([name, data]) => ({ name: capitalize(name), value: data.reactions }))
                .sort((a, b) => b.value - a.value);
            const reactionsChart = createBarChart('Like e Reazioni', reactionsData);

            container.appendChild(createChartWrapper('Post Pubblicati', postsChart));
            container.appendChild(createChartWrapper('Visualizzazioni', viewsChart));
            container.appendChild(createChartWrapper('Interazioni', interactionsChart));
            container.appendChild(createChartWrapper('Like e Reazioni', reactionsChart));
        }

        function createChartWrapper(title, chart) {
            const wrapper = document.createElement('div');
            wrapper.className = 'chart-wrapper';
            wrapper.innerHTML = `
                <div class="chart">${chart}</div>
                <div class="export-section">
                    <button class="secondary-btn" onclick="exportChart('${title.replace(/\s+/g, '_')}', this.parentElement.previousElementSibling)">
                        <span>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="#0033A0">
                                <path d="M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z"/>
                            </svg>
                        </span>
                        <span>Esporta SVG</span>
                    </button>
                </div>
            `;
            return wrapper;
        }

        function createBarChart(title, data, isPostsChart = false) {
            const maxValue = Math.max(...data.map(d => parseFloat(d.value)));
            
            // Formato 4:5 (alto 4, largo 5)
            const svgHeight = 400;
            const svgWidth = 500;
            const margin = { top: 60, right: 30, bottom: 120, left: 60 }; // Increased bottom margin for logos
            const chartWidth = svgWidth - margin.left - margin.right;
            const chartHeight = svgHeight - margin.top - margin.bottom;
            
            const barWidth = chartWidth / data.length * 0.7;
            const barSpacing = chartWidth / data.length * 0.3;
            
            let svg = `<svg width="${svgWidth}" height="${svgHeight}" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="gradient1" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#FFD800;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#ffed4a;stop-opacity:1" />
                    </linearGradient>
                    <linearGradient id="gradient2" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#0033A0;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#0056b3;stop-opacity:1" />
                    </linearGradient>
                </defs>`;
                
            // Title
            svg += `<text x="${svgWidth/2}" y="30" text-anchor="middle" 
                    font-family="'Avenir Next LT Pro', Arial, sans-serif" font-size="20" 
                    fill="#0033A0" font-weight="400">${title}</text>`;
            
            // Draw bars
            data.forEach((item, index) => {
                const barHeight = maxValue > 0 ? (parseFloat(item.value) / maxValue) * chartHeight : 0;
                const x = margin.left + (index * (barWidth + barSpacing));
                const y = margin.top + (chartHeight - barHeight);
                const gradient = index % 2 === 0 ? 'gradient1' : 'gradient2';
                
                svg += `<rect x="${x}" y="${y}" width="${barWidth}" height="${barHeight}" 
                        fill="url(#${gradient})" rx="4" ry="4">
                        <title>${item.name}: ${isPostsChart ? item.value : formatNumberForCharts(item.value)}</title>
                        </rect>`;
                
                // Value labels
                const displayValue = isPostsChart ? item.value : formatNumberForCharts(item.value);
                svg += `<text x="${x + barWidth/2}" y="${y - 8}" text-anchor="middle" 
                        font-family="'Avenir Next LT Pro', Arial, sans-serif" font-size="14" 
                        fill="#333" font-weight="600">
                        ${displayValue}
                        </text>`;
                
                // Platform labels - horizontal
                svg += `<text x="${x + barWidth/2}" y="${svgHeight - 70}" text-anchor="middle" 
                        font-family="'Avenir Next LT Pro', Arial, sans-serif" font-size="14" 
                        fill="#0033A0" font-weight="600">
                        ${item.name}
                        </text>`;
                
                // Add social logo
                const logoName = item.name.toLowerCase();
                const logo = socialLogos[logoName] || socialLogos['sconosciuto'];
                const logoY = svgHeight - 50;
                svg += `<g transform="translate(${x + barWidth/2 - 10}, ${logoY})">${logo}</g>`;
            });
            
            svg += '</svg>';
            return svg;
        }

        function exportChart(chartName, chartElement) {
            const button = event.target.closest('button');
            const originalContent = button.innerHTML;
            
            button.innerHTML = '<span class="loading-spinner"></span><span>Esportazione...</span>';
            button.classList.add('loading');
            
            setTimeout(() => {
                const svgContent = chartElement.innerHTML;
                const blob = new Blob([svgContent], { type: 'image/svg+xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${chartName}.svg`;
                a.click();
                URL.revokeObjectURL(url);
                
                button.innerHTML = '<span>✅</span><span>Esportato!</span>';
                button.classList.remove('loading');
                button.classList.add('success');
                
                setTimeout(() => {
                    button.innerHTML = originalContent;
                    button.classList.remove('success');
                }, 2000);
            }, 1000);
        }

        // Generate HTML report with charts
        function generateHTMLReport() {
            const title = `Risultati social`;
            const subtitle = campaignLabel;
            
            let htmlContent = `<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${title} - ${subtitle}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Roboto', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: #0033A0;
            text-align: center;
            margin-bottom: 5px;
            font-size: clamp(1.5em, 5vw, 2.2em);
        }
        
        h2 {
            color: #0033A0;
            text-align: center;
            margin-top: 0;
            margin-bottom: 30px;
            font-size: clamp(1.2em, 4vw, 1.8em);
            font-weight: normal;
        }
        
        .chart-container, .metrics-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            overflow-x: auto;
        }
        
        .metrics-container {
            padding: 15px;
        }
        
        svg {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            h1 {
                margin-bottom: 10px;
            }
            
            h2 {
                margin-bottom: 20px;
            }
            
            .chart-container, .metrics-container {
                padding: 15px;
                margin-bottom: 20px;
            }
            
            /* Allow horizontal scroll for wide SVGs on mobile */
            .chart-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Ensure SVGs maintain aspect ratio */
            svg {
                min-width: 320px;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            .chart-container, .metrics-container {
                padding: 10px;
                border-radius: 6px;
            }
        }
        
        /* Print styles */
        @media print {
            body {
                background-color: white;
            }
            
            .chart-container, .metrics-container {
                box-shadow: none;
                border: 1px solid #ddd;
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>${title}</h1>
        <h2>${subtitle}</h2>
        
        <div class="metrics-container">
            ${window.metricsSVG}
        </div>`;

            // Add all charts
            const charts = document.querySelectorAll('.chart');
            charts.forEach((chart, index) => {
                htmlContent += `
        <div class="chart-container">
            ${chart.innerHTML}
        </div>`;
            });

            htmlContent += `
    </div>
</body>
</html>`;

            return htmlContent;
        }

        // Event listeners
        document.getElementById("file-input").addEventListener("change", function(e) {
            const file = e.target.files[0];
            if (file) {
                processExcelFile(file);
            }
        });

        document.getElementById("copy-btn").addEventListener("click", async function() {
            const button = this;
            const originalContent = button.innerHTML;
            
            button.innerHTML = '<span class="loading-spinner"></span><span>Copiando...</span>';
            button.classList.add('loading');
            
            setTimeout(async () => {
                const html = document.getElementById("report").innerHTML;
                const blob = new Blob([html], { type: "text/html" });
                const data = [new ClipboardItem({ "text/html": blob })];
                try {
                    await navigator.clipboard.write(data);
                    button.innerHTML = '<span>✅</span><span>Copiato!</span>';
                    button.classList.remove('loading');
                    button.classList.add('success');
                } catch (err) {
                    button.innerHTML = '<span>⚠️</span><span>Errore</span>';
                    button.classList.remove('loading');
                    alert("Copia fallita. Il browser potrebbe non supportare questa funzione.");
                }
                
                setTimeout(() => {
                    button.innerHTML = originalContent;
                    button.classList.remove('success');
                }, 2000);
            }, 800);
        });

        document.getElementById("download-btn").addEventListener("click", function() {
            const button = this;
            const originalContent = button.innerHTML;
            
            button.innerHTML = '<span class="loading-spinner"></span><span>Generando...</span>';
            button.classList.add('loading');
            
            setTimeout(() => {
                const htmlContent = `
<html><head><meta charset='utf-8'></head><body style="font-family:Arial; font-size:14px;">
${latestHtml}
</body></html>`;
                const blob = new Blob([htmlContent], {type: "application/msword"});
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "Report_Campagna_Social.doc";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                button.innerHTML = '<span>✅</span><span>Scaricato!</span>';
                button.classList.remove('loading');
                button.classList.add('success');
                
                setTimeout(() => {
                    button.innerHTML = originalContent;
                    button.classList.remove('success');
                }, 2000);
            }, 1200);
        });

        // Download HTML report button
        document.getElementById("download-html-btn").addEventListener("click", function() {
            const button = this;
            const originalContent = button.innerHTML;
            
            if (!campaignData) {
                alert("Per favore carica prima un file Excel");
                return;
            }
            
            button.innerHTML = '<span class="loading-spinner"></span><span>Generando HTML...</span>';
            button.classList.add('loading');
            
            setTimeout(() => {
                const htmlReport = generateHTMLReport();
                const blob = new Blob([htmlReport], {type: "text/html"});
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `Report_${campaignLabel.replace(/\s+/g, '_')}.html`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                button.innerHTML = '<span>✅</span><span>HTML Scaricato!</span>';
                button.classList.remove('loading');
                button.classList.add('success');
                
                setTimeout(() => {
                    button.innerHTML = originalContent;
                    button.classList.remove('success');
                }, 2000);
            }, 1500);
        });

        // Export all charts functionality
        document.getElementById('exportAllBtn').addEventListener('click', function() {
            const button = this;
            const originalContent = button.innerHTML;
            
            button.innerHTML = '<span class="loading-spinner"></span><span>Esportazione in corso...</span>';
            button.classList.add('loading');
            
            setTimeout(() => {
                const charts = document.querySelectorAll('.chart');
                charts.forEach((chart, index) => {
                    const svgContent = chart.innerHTML;
                    const blob = new Blob([svgContent], { type: 'image/svg+xml' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `grafico_${index + 1}.svg`;
                    a.click();
                    URL.revokeObjectURL(url);
                });
                
                button.innerHTML = '<span>✅</span><span>Tutti i grafici esportati!</span>';
                button.classList.remove('loading');
                button.classList.add('success');
                
                setTimeout(() => {
                    button.innerHTML = originalContent;
                    button.classList.remove('success');
                }, 3000);
            }, 1500);
        });

        // Export metrics functionality
        document.getElementById('exportMetricsBtn').addEventListener('click', function() {
            const button = this;
            const originalContent = button.innerHTML;
            
            button.innerHTML = '<span class="loading-spinner"></span><span>Esportando...</span>';
            button.classList.add('loading');
            
            setTimeout(() => {
                if (window.metricsSVG) {
                    const blob = new Blob([window.metricsSVG], { type: 'image/svg+xml' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'metriche_generali.svg';
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    button.innerHTML = '<span>✅</span><span>Esportato!</span>';
                    button.classList.add('success');
                } else {
                    button.innerHTML = '<span>⚠️</span><span>Errore</span>';
                }
                button.classList.remove('loading');
                
                setTimeout(() => {
                    button.innerHTML = originalContent;
                    button.classList.remove('success');
                }, 2000);
            }, 1000);
        });
    </script>
</body>
</html>
