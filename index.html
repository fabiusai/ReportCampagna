<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Sentiment Dashboard</title>
    <link rel="icon" href="favicon.ico">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --brand-blue: #0146bc;
            --brand-yellow: #eddc01;
            --text-dark: #333333;
            --text-light: #ffffff;
            --bg-light: #f4f6f9;
            --border-color: #dcdcdc;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --font-legend: 'Avenir Next LT Pro', 'Avenir Next', 'Avenir', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Roboto', sans-serif; background-color: var(--bg-light); color: var(--text-dark); display: flex; flex-direction: column; min-height: 100vh; }

        /* HEADER */
        header { background-color: var(--brand-blue); color: var(--text-light); padding: 1rem 2rem; border-bottom: 5px solid var(--brand-yellow); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        header h1 { font-size: 1.5rem; font-weight: 500; }

        /* MAIN */
        main { flex: 1; padding: 2rem; max-width: 1200px; margin: 0 auto; width: 100%; }
        .section-title { font-size: 1.2rem; color: var(--brand-blue); margin-bottom: 1rem; border-left: 4px solid var(--brand-yellow); padding-left: 10px; text-transform: uppercase; letter-spacing: 0.5px; }

        /* UPLOAD */
        .upload-container { background: white; padding: 2rem; border-radius: 4px; border: 1px solid var(--border-color); text-align: center; margin-bottom: 2rem; transition: border-color 0.3s; }
        .upload-container:hover { border-color: var(--brand-blue); }
        input[type="file"] { display: none; }
        .custom-file-upload { display: inline-block; padding: 12px 24px; cursor: pointer; background-color: var(--brand-blue); color: white; font-weight: 500; border-radius: 2px; transition: background 0.3s; }
        .custom-file-upload:hover { opacity: 0.9; }

        /* DASHBOARD */
        .dashboard { display: grid; grid-template-columns: 1fr 2fr; gap: 2rem; margin-bottom: 2rem; }
        @media (max-width: 900px) { .dashboard { grid-template-columns: 1fr; } }
        .card-box { background: white; padding: 1.5rem; border-radius: 4px; border: 1px solid var(--border-color); box-shadow: 0 1px 3px rgba(0,0,0,0.05); display: flex; flex-direction: column; }

        /* CHART & LEGEND */
        .chart-wrapper { position: relative; height: 250px; width: 100%; display: flex; justify-content: center; margin-bottom: 1rem; }
        .custom-legend { display: flex; justify-content: center; gap: 20px; margin-top: 10px; flex-wrap: wrap; }
        .legend-item { text-align: center; font-family: var(--font-legend); }
        .legend-color { width: 12px; height: 12px; display: inline-block; border-radius: 50%; margin-right: 5px; }
        .legend-label { font-size: 0.9rem; color: #555; font-weight: 500; display: block; }
        .legend-percent { font-size: 1.2rem; font-weight: 700; color: var(--text-dark); display: block; margin-top: 2px; }

        /* --- NUOVO LAYOUT FILTRI --- */
        .filters-container {
            background: var(--bg-light);
            border-radius: 4px;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        /* Riga 1: Dropdown */
        .filters-row-top {
            padding: 1rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            border-bottom: 1px solid #e1e4e8;
        }

        /* Riga 2: Date e Reset */
        .filters-row-bottom {
            padding: 10px 1rem;
            background-color: #eef2f8; /* Colore leggermente diverso per distinguere la timeline */
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }

        .filter-group { display: flex; flex-direction: column; gap: 4px; }
        .filter-group label { font-size: 0.75rem; font-weight: 500; color: #666; text-transform: uppercase; }
        
        .filter-select { padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-dark); font-size: 0.85rem; outline: none; width: 100%; background: white; }
        .filter-select:focus { border-color: var(--brand-blue); }

        .date-inputs { display: flex; align-items: center; gap: 10px; }
        .filter-input-date { padding: 6px 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.85rem; outline: none; color: var(--text-dark); }
        .filter-input-date:focus { border-color: var(--brand-blue); }

        .btn-reset {
            background: none;
            border: 1px solid var(--brand-blue);
            color: var(--brand-blue);
            padding: 5px 10px;
            font-size: 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-reset:hover { background: var(--brand-blue); color: white; }

        /* COMMENTS LIST */
        .comments-list { background: white; border: 1px solid var(--border-color); border-radius: 4px; max-height: 500px; overflow-y: auto; }
        .comment-item { padding: 1rem; border-bottom: 1px solid var(--bg-light); display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; }
        .comment-item:last-child { border-bottom: none; }
        .comment-content { flex: 1; }
        .comment-meta { font-size: 0.85rem; color: #666; margin-bottom: 0.5rem; display: flex; gap: 10px; align-items: center; }
        
        .sentiment-badge { padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; color: white; }
        .sentiment-positive { background-color: var(--success); }
        .sentiment-neutral { background-color: var(--warning); color: #333; }
        .sentiment-negative { background-color: var(--danger); }
        .platform-icon-small { width: 14px; height: 14px; fill: #666; margin-right: 4px; vertical-align: middle; }

        .btn { border: none; padding: 8px 16px; font-size: 0.8rem; cursor: pointer; border-radius: 2px; font-weight: 500; transition: all 0.2s; text-transform: uppercase; white-space: nowrap; }
        .btn-editor { background-color: var(--bg-light); color: var(--brand-blue); border: 1px solid var(--brand-blue); }
        .btn-editor:hover { background-color: var(--brand-blue); color: white; }
        .btn-download { background-color: var(--brand-yellow); color: var(--brand-blue); }

        /* MODAL */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 4px; width: 90%; max-width: 600px; border-top: 5px solid var(--brand-blue); max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .close { font-size: 1.5rem; font-weight: bold; cursor: pointer; color: #aaa; }
        .close:hover { color: var(--text-dark); }
        .editor-controls { margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-light); border-radius: 4px; }
        .control-group { margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }

        /* PREVIEW CARD */
        #cardPreviewContainer { display: flex; justify-content: center; margin-bottom: 1.5rem; padding: 20px; background-color: #e0e0e0; border-radius: 4px; }
        .social-card { background: white; width: 100%; max-width: 400px; padding: 25px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); font-family: 'Roboto', sans-serif; display: flex; flex-direction: column; gap: 15px; position: relative; overflow: hidden; transition: all 0.3s ease; }
        .social-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background-color: var(--brand-blue); }
        .card-header { display: flex; align-items: center; justify-content: space-between; }
        .card-icon { width: 24px; height: 24px; fill: var(--brand-blue); }
        .card-date { font-size: 0.8rem; color: #999; font-weight: 400; }
        .card-body { font-size: 1.1rem; line-height: 1.5; color: #222; }
        .card-footer { margin-top: auto; border-top: 1px solid #eee; padding-top: 10px; font-size: 0.9rem; font-weight: 500; color: var(--brand-blue); min-height: 20px; }
        .hidden { display: none !important; }

        /* Icone */
        .icon-fb path { fill: #1877F2; }
        .icon-ig path { fill: #E4405F; }
        .icon-tw path { fill: #000000; }
        .icon-generic path { fill: var(--brand-blue); }

        footer { margin-top: auto; background-color: white; border-top: 1px solid var(--border-color); padding: 1rem 2rem; text-align: center; font-size: 0.8rem; color: #888; display: flex; justify-content: space-between; }
        .app-version { font-family: monospace; background: var(--bg-light); padding: 2px 6px; border-radius: 3px; color: var(--brand-blue); font-weight: bold; }
    </style>
</head>
<body>

<header>
    <h1>Social Sentiment Analyzer</h1>
    <div style="width: 40px; height: 40px; background-color: var(--brand-yellow);"></div>
</header>

<main>
    <section class="upload-container">
        <h2 style="margin-bottom: 15px; color: var(--brand-blue);">Importazione Dati</h2>
        <p style="margin-bottom: 20px; color: #666;">Carica i file <strong>Excel (.xlsx)</strong> o <strong>CSV</strong>.<br>Il sistema cercherà automaticamente il foglio con i commenti.</p>
        <label for="fileInput" class="custom-file-upload" id="uploadBtnLabel">
            Seleziona File
        </label>
        <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" multiple>
        <p id="fileCount" style="margin-top: 10px; font-size: 0.9rem; color: var(--brand-blue);"></p>
        <p id="errorMsg" style="margin-top: 10px; font-size: 0.9rem; color: var(--danger); display:none;"></p>
    </section>

    <div id="appContent" class="hidden">
        <div class="dashboard">
            <div class="card-box">
                <h3 class="section-title">Sentiment Overview</h3>
                <div style="margin-bottom: 1rem;">
                    <strong>Totale Commenti:</strong> <span id="totalComments">0</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="sentimentChart"></canvas>
                </div>
                <div id="customLegend" class="custom-legend"></div>
            </div>
            
            <div class="card-box">
                <h3 class="section-title" style="margin-bottom: 10px;">Feed Commenti</h3>
                
                <div class="filters-container">
                    <div class="filters-row-top">
                        <div class="filter-group">
                            <label>Sentiment</label>
                            <select id="filterSentiment" class="filter-select">
                                <option value="all">Tutti</option>
                                <option value="positive">Positivi</option>
                                <option value="neutral">Neutri</option>
                                <option value="negative">Negativi</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Canale</label>
                            <select id="filterPlatform" class="filter-select">
                                <option value="all">Tutti</option>
                                <option value="facebook">Facebook</option>
                                <option value="instagram">Instagram</option>
                                <option value="twitter">X (Twitter)</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Ordina per</label>
                            <select id="sortOrder" class="filter-select">
                                <option value="dateDesc">Data (Più recenti)</option>
                                <option value="dateAsc">Data (Meno recenti)</option>
                                <option value="lenDesc">Lunghezza (Lungo-Corto)</option>
                                <option value="lenAsc">Lunghezza (Corto-Lungo)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="filters-row-bottom">
                        <div class="date-inputs">
                            <label style="font-size: 0.75rem; font-weight: 500; color: #666; text-transform: uppercase;">Periodo:</label>
                            <input type="date" id="dateStart" class="filter-input-date" placeholder="Da">
                            <span style="font-size: 0.8rem; color:#666;">-</span>
                            <input type="date" id="dateEnd" class="filter-input-date" placeholder="A">
                        </div>
                        <button class="btn-reset" id="resetFiltersBtn">Reset Filtri</button>
                    </div>
                </div>

                <div class="comments-list" id="commentsList"></div>
            </div>
        </div>
    </div>
</main>

<footer>
    <span>Internal Use Only</span>
    <span class="app-version">v1.5.0 Split-Filters</span>
</footer>

<div id="editorModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 style="color: var(--brand-blue);">Editor Card Social</h2>
            <span class="close" id="closeModal">&times;</span>
        </div>
        <div class="editor-controls">
            <div class="control-group">
                <input type="checkbox" id="toggleAuthor" checked>
                <label for="toggleAuthor" style="cursor: pointer;">Mostra Nome Autore</label>
            </div>
        </div>
        <div id="cardPreviewContainer">
            <div class="social-card" id="captureCard">
                <div class="card-header">
                    <svg class="card-icon" id="cardIcon" viewBox="0 0 24 24">
                        <path d=""/>
                    </svg>
                    <span class="card-date" id="cardDate">DD/MM/YYYY HH:MM</span>
                </div>
                <div class="card-body" id="cardText">Testo...</div>
                <div class="card-footer" id="cardAuthor">Nome Autore</div>
            </div>
        </div>
        <div style="text-align: right;">
            <button class="btn btn-download" id="downloadCardBtn">Scarica Card</button>
        </div>
    </div>
</div>

<script>
    // --- SETUP & VARS ---
    let allComments = [];
    let displayedComments = [];
    let myChart = null;

    // DOM Elements
    const fileInput = document.getElementById('fileInput');
    const uploadLabel = document.getElementById('uploadBtnLabel');
    const fileCountDisplay = document.getElementById('fileCount');
    const errorMsg = document.getElementById('errorMsg');
    const appContent = document.getElementById('appContent');
    const commentsList = document.getElementById('commentsList');
    const totalCommentsSpan = document.getElementById('totalComments');
    const customLegend = document.getElementById('customLegend');

    // Filter DOM Elements
    const filterSentiment = document.getElementById('filterSentiment');
    const filterPlatform = document.getElementById('filterPlatform');
    const sortOrder = document.getElementById('sortOrder');
    const dateStart = document.getElementById('dateStart');
    const dateEnd = document.getElementById('dateEnd');
    const resetFiltersBtn = document.getElementById('resetFiltersBtn');
    
    // Modal & Editor
    const modal = document.getElementById('editorModal');
    const closeModal = document.getElementById('closeModal');
    const toggleAuthor = document.getElementById('toggleAuthor');
    const cardAuthor = document.getElementById('cardAuthor');
    const cardText = document.getElementById('cardText');
    const cardDate = document.getElementById('cardDate');
    const cardIcon = document.getElementById('cardIcon');
    const downloadBtn = document.getElementById('downloadCardBtn');
    const captureArea = document.getElementById('captureCard');

    // Icons Paths
    const icons = {
        facebook: "M12 2.04C6.5 2.04 2 6.53 2 12.06C2 17.06 5.66 21.21 10.44 21.96V14.96H7.9V12.06H10.44V9.85C10.44 7.34 11.93 5.96 14.15 5.96C15.21 5.96 16.12 6.04 16.12 6.04V8.51H15.01C13.77 8.51 13.38 9.28 13.38 10.07V12.06H16.15L15.71 14.96H13.38V21.96C18.16 21.21 21.82 17.06 21.82 12.06C21.82 6.53 17.32 2.04 12 2.04Z",
        instagram: "M7.8,2H16.2C19.4,2 22,4.6 22,7.8V16.2A5.8,5.8 0 0,1 16.2,22H7.8C4.6,22 2,19.4 2,16.2V7.8A5.8,5.8 0 0,1 7.8,2M7.6,4A3.6,3.6 0 0,0 4,7.6V16.4C4,18.39 5.61,20 7.6,20H16.4A3.6,3.6 0 0,0 20,16.4V7.6C20,5.61 18.39,4 16.4,4H7.6M17.25,5.5A1.25,1.25 0 0,1 18.5,6.75A1.25,1.25 0 0,1 17.25,8A1.25,1.25 0 0,1 16,6.75A1.25,1.25 0 0,1 17.25,5.5M12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9Z",
        twitter: "M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z",
        default: "M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"
    };

    // --- HELPER DATE ---
    function parseDate(dateInput) {
        let d;
        if (typeof dateInput === 'number') {
            const excelEpoch = new Date(1899, 11, 30);
            d = new Date(excelEpoch.getTime() + dateInput * 86400000);
        } else if (typeof dateInput === 'string') {
            const parts = dateInput.split(/[\/\-\s:]/);
            if (dateInput.includes('/')) {
                const day = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1;
                const year = parseInt(parts[2], 10);
                const hour = parseInt(parts[3], 10) || 0;
                const min = parseInt(parts[4], 10) || 0;
                d = new Date(year, month, day, hour, min);
            } else {
                d = new Date(dateInput);
            }
        } else {
            d = new Date(dateInput);
        }
        return d;
    }

    function formatDate(dateObj) {
        if (isNaN(dateObj.getTime())) return "N/A";
        return dateObj.toLocaleString('it-IT', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute:'2-digit' });
    }

    function getPlatformFromLink(link) {
        if (!link) return 'other';
        link = String(link).toLowerCase();
        if (link.includes('facebook')) return 'facebook';
        if (link.includes('instagram')) return 'instagram';
        if (link.includes('twitter') || link.includes('x.com')) return 'twitter';
        return 'other';
    }

    function getPlatformIconPath(platform) {
        if (platform === 'facebook') return icons.facebook;
        if (platform === 'instagram') return icons.instagram;
        if (platform === 'twitter') return icons.twitter;
        return icons.default;
    }

    // --- FILE HANDLING ---
    fileInput.addEventListener('change', (e) => {
        const files = e.target.files;
        if (files.length === 0) return;

        uploadLabel.innerText = "Analisi in corso...";
        errorMsg.style.display = 'none';
        
        allComments = [];
        let filesProcessed = 0;

        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                try {
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    let targetSheetName = workbook.SheetNames.find(name => 
                        name.toLowerCase().includes('comment') || name.toLowerCase().includes('replies')
                    );

                    let jsonData = null;
                    if (targetSheetName) {
                        jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[targetSheetName], { defval: "" });
                        if (!checkColumns(jsonData)) jsonData = null;
                    }

                    if (!jsonData) {
                        for (const name of workbook.SheetNames) {
                            const temp = XLSX.utils.sheet_to_json(workbook.Sheets[name], { defval: "" });
                            if (checkColumns(temp)) {
                                jsonData = temp;
                                break;
                            }
                        }
                    }

                    if (jsonData) processData(jsonData, file.name);

                } catch (error) {
                    console.error("Errore lettura file:", file.name, error);
                }
                
                filesProcessed++;
                if (filesProcessed === files.length) {
                    finalizeUpload();
                }
            };
            reader.readAsArrayBuffer(file);
        });
    });

    function checkColumns(data) {
        if (!data || data.length === 0) return false;
        return data.some(row => row['Comment Message'] && row['Sentiment']);
    }

    function processData(data, filename) {
        data.forEach(row => {
            const msg = row['Comment Message'];
            const sent = row['Sentiment'];

            if (msg && sent) {
                const d = parseDate(row['Created Time']);
                const platform = getPlatformFromLink(row['Comment Link']);
                
                const comment = {
                    message: String(msg),
                    sentiment: String(sent),
                    dateObj: d,
                    author: row['Comment User Name'] || 'Utente',
                    link: row['Comment Link'] || '',
                    platform: platform,
                    sourceFile: filename
                };

                allComments.push(comment);
            }
        });
    }

    function finalizeUpload() {
        if (allComments.length > 0) {
            updateUI();
            uploadLabel.innerText = "Fatto!";
            fileCountDisplay.innerText = `Analisi completata: ${allComments.length} commenti trovati.`;
        } else {
            errorMsg.innerText = "Errore: Nessun commento valido trovato.";
            errorMsg.style.display = 'block';
            uploadLabel.innerText = "Riprova";
        }
        setTimeout(() => { 
            if(uploadLabel.innerText === "Fatto!") uploadLabel.innerText = "Seleziona File"; 
        }, 2000);
    }

    // --- MAIN UI LOGIC ---
    function updateUI() {
        appContent.classList.remove('hidden');
        applyFilters(); 
    }

    // Reset Logic
    resetFiltersBtn.addEventListener('click', () => {
        filterSentiment.value = 'all';
        filterPlatform.value = 'all';
        sortOrder.value = 'dateDesc';
        dateStart.value = '';
        dateEnd.value = '';
        applyFilters();
    });

    // Event Listeners sui filtri
    [filterSentiment, filterPlatform, sortOrder, dateStart, dateEnd].forEach(el => {
        el.addEventListener('change', applyFilters);
    });

    function applyFilters() {
        // 1. Filtra l'array originale
        displayedComments = allComments.filter(c => {
            // Sentiment
            const s = c.sentiment.toLowerCase();
            const fSent = filterSentiment.value;
            if (fSent === 'positive' && !s.includes('positive')) return false;
            if (fSent === 'negative' && !s.includes('negative')) return false;
            if (fSent === 'neutral' && !s.includes('neutral')) return false;

            // Platform
            if (filterPlatform.value !== 'all' && c.platform !== filterPlatform.value) return false;

            // Date Range
            if (dateStart.value) {
                const start = new Date(dateStart.value);
                if (c.dateObj < start) return false;
            }
            if (dateEnd.value) {
                const end = new Date(dateEnd.value);
                end.setHours(23,59,59);
                if (c.dateObj > end) return false;
            }

            return true;
        });

        // 2. Ordinamento
        const order = sortOrder.value;
        displayedComments.sort((a, b) => {
            if (order === 'dateDesc') return b.dateObj - a.dateObj;
            if (order === 'dateAsc') return a.dateObj - b.dateObj;
            if (order === 'lenDesc') return b.message.length - a.message.length;
            if (order === 'lenAsc') return a.message.length - b.message.length;
            return 0;
        });

        // 3. Aggiorna Vista
        totalCommentsSpan.innerText = displayedComments.length;
        renderCommentsList();
        renderChart(); 
    }

    function renderCommentsList() {
        commentsList.innerHTML = '';
        displayedComments.forEach((comment, index) => {
            const div = document.createElement('div');
            div.className = 'comment-item';
            
            let badgeClass = 'sentiment-neutral';
            const s = comment.sentiment.toLowerCase();
            if (s.includes('positive')) badgeClass = 'sentiment-positive';
            if (s.includes('negative')) badgeClass = 'sentiment-negative';

            const iconPath = getPlatformIconPath(comment.platform);
            
            div.innerHTML = `
                <div class="comment-content">
                    <div class="comment-meta">
                        <span class="sentiment-badge ${badgeClass}">${comment.sentiment}</span>
                        <span>
                            <svg class="platform-icon-small" viewBox="0 0 24 24"><path d="${iconPath}"/></svg>
                            ${formatDate(comment.dateObj).split(',')[0]}
                        </span>
                    </div>
                    <p>${comment.message.substring(0, 150)}${comment.message.length > 150 ? '...' : ''}</p>
                </div>
                <button class="btn btn-editor" onclick="openEditor(${index})">Editor</button>
            `;
            commentsList.appendChild(div);
        });
    }

    function renderChart() {
        const ctx = document.getElementById('sentimentChart').getContext('2d');
        if (myChart) myChart.destroy();

        let counts = { Positive: 0, Neutral: 0, Negative: 0 };
        displayedComments.forEach(c => {
            const s = c.sentiment.toLowerCase();
            if (s.includes('positive')) counts.Positive++;
            else if (s.includes('negative')) counts.Negative++;
            else counts.Neutral++;
        });

        const total = counts.Positive + counts.Neutral + counts.Negative;
        
        const pPos = total ? Math.round((counts.Positive / total) * 100) : 0;
        const pNeu = total ? Math.round((counts.Neutral / total) * 100) : 0;
        const pNeg = total ? Math.round((counts.Negative / total) * 100) : 0;

        const cPos = '#28a745';
        const cNeu = '#ffc107';
        const cNeg = '#dc3545';

        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Positivo', 'Neutro', 'Negativo'],
                datasets: [{
                    data: [counts.Positive, counts.Neutral, counts.Negative],
                    backgroundColor: [cPos, cNeu, cNeg],
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: true }
                },
                cutout: '70%'
            }
        });

        customLegend.innerHTML = `
            <div class="legend-item">
                <span class="legend-label"><span class="legend-color" style="background:${cPos}"></span>Positivo</span>
                <span class="legend-percent">${pPos}%</span>
            </div>
            <div class="legend-item">
                <span class="legend-label"><span class="legend-color" style="background:${cNeu}"></span>Neutro</span>
                <span class="legend-percent">${pNeu}%</span>
            </div>
            <div class="legend-item">
                <span class="legend-label"><span class="legend-color" style="background:${cNeg}"></span>Negativo</span>
                <span class="legend-percent">${pNeg}%</span>
            </div>
        `;
    }

    // --- EDITOR MODAL ---
    function openEditor(index) {
        const comment = displayedComments[index];
        
        cardText.innerText = comment.message;
        cardDate.innerText = formatDate(comment.dateObj);
        cardAuthor.innerText = comment.author;
        
        const path = getPlatformIconPath(comment.platform);
        const pathElem = cardIcon.querySelector('path');
        pathElem.setAttribute('d', path);
        
        if (comment.platform === 'facebook') pathElem.style.fill = '#1877F2';
        else if (comment.platform === 'instagram') pathElem.style.fill = '#E4405F';
        else if (comment.platform === 'twitter') pathElem.style.fill = '#000000';
        else pathElem.style.fill = '#0146bc';

        toggleAuthor.checked = true;
        cardAuthor.style.display = 'block';

        modal.style.display = 'flex';
    }

    closeModal.onclick = () => { modal.style.display = 'none'; }
    window.onclick = (event) => { if (event.target == modal) modal.style.display = 'none'; }

    toggleAuthor.addEventListener('change', (e) => {
        cardAuthor.style.display = e.target.checked ? 'block' : 'none';
    });

    downloadBtn.addEventListener('click', () => {
        downloadBtn.innerText = "Generazione...";
        html2canvas(captureArea, { scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            link.download = `social-card-${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
            downloadBtn.innerText = "Fatto!";
            setTimeout(() => downloadBtn.innerText = "Scarica Card", 1500);
        });
    });

</script>

</body>
</html>
